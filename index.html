<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>RBM Japan Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        
        :root { --primary: #047857; --accent: #10b981; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0fdf4; -webkit-tap-highlight-color: transparent; }
        .font-display { font-family: 'Outfit', sans-serif; }

        /* MESH GRADIENT (Nuansa Premium & Tenang) */
        .mesh-bg {
            background-color: #ecfdf5;
            background-image: 
                radial-gradient(at 0% 0%, hsla(147,100%,90%,1) 0, transparent 50%), 
                radial-gradient(at 100% 100%, hsla(160,100%,85%,1) 0, transparent 50%);
        }

        /* CARD STYLES */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* KARTU SPP (Virtual Card) */
        .virtual-card {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white; position: relative; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(4, 120, 87, 0.3);
        }
        /* Pola Geometris Halus di Kartu */
        .virtual-card::after {
            content: ""; position: absolute; right: -20px; bottom: -20px; width: 150px; height: 150px;
            background: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 10px, transparent 10px, transparent 20px);
            border-radius: 50%; pointer-events: none;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .ticker-text { animation: marquee 25s linear infinite; display: inline-block; white-space: nowrap; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* Toast & Modal */
        #toast { visibility: hidden; opacity: 0; transition: all 0.3s; transform: translateY(20px); }
        #toast.show { visibility: visible; opacity: 1; transform: translateY(0); }
        .modal-backdrop { opacity: 0; pointer-events: none; transition: all 0.3s; }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.95); opacity: 0; transition: all 0.3s; }
        .modal-backdrop.active .modal-content { transform: scale(1); opacity: 1; }
    </style>
</head>
<body class="min-h-screen mesh-bg text-slate-800">

    <div id="loader" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-emerald-100 border-t-emerald-600 rounded-full animate-spin mb-4"></div>
        <p class="text-[10px] font-bold text-emerald-800 tracking-widest uppercase animate-pulse">Memuat Data...</p>
    </div>

    <div id="app" class="relative z-10 hidden max-w-md mx-auto min-h-screen shadow-2xl bg-white/40 border-x border-white"></div>

    <div class="fixed bottom-8 left-0 right-0 z-[60] flex justify-center pointer-events-none">
        <div id="toast" class="bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl flex items-center gap-3 text-xs font-bold">
            <i data-lucide="check-circle" class="text-emerald-400" width="16"></i> <span id="toast-msg">Berhasil!</span>
        </div>
    </div>

    <div id="modal-transfer" class="modal-backdrop fixed inset-0 z-[70] flex items-center justify-center px-6">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="toggleModal(false)"></div>
        <div class="modal-content bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl relative z-10">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-display font-bold text-lg text-slate-800">Info Rekening</h3>
                <button onclick="toggleModal(false)" class="bg-slate-100 p-2 rounded-full hover:bg-slate-200"><i data-lucide="x" width="16"></i></button>
            </div>
            
            <div class="bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200 rounded-2xl p-6 text-center mb-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Japan_Post_Bank_logo.svg/1200px-Japan_Post_Bank_logo.svg.png" class="h-6 mx-auto mb-4 opacity-80">
                <div class="flex items-center justify-center gap-2 mb-1">
                    <h2 class="text-2xl font-black text-slate-800 tracking-tighter" id="rek-number">10120-12345678</h2>
                    <button onclick="copyText('10120-12345678', 'Nomor Rekening')" class="text-emerald-600 bg-emerald-50 hover:bg-emerald-100 p-2 rounded-lg transition"><i data-lucide="copy" width="16"></i></button>
                </div>
                <p class="text-xs font-bold text-slate-500 uppercase tracking-wide">a.n RBM JAPAN ADMIN</p>
            </div>
            <p class="text-[10px] text-slate-400 text-center">Mohon simpan bukti transfer Anda.</p>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const API_URL = "https://script.google.com/macros/s/AKfycbz2a5-sm2_gLBPF5jpTmZfBuN9PppkvUI3nXIyOJbYJ4XDZA3SDE7-FNU784ZxfSZjr/exec"; 
        const WEBSITE_URL = "https://rbj-site.vercel.app/";
        const ADMIN_WA = "6285819809668";
        
        // --- STATE & DATA ---
        let DATA_SISWA = [], DATA_HARGA = {}, KABAR_RBM = [], INFO_PENGUMUMAN = {};
        let STATE = { view: 'login', user: null, lang: 'id' };
        
        const DAY_NAMES = {
            id: { 'Senin': 'Senin', 'Selasa': 'Selasa', 'Rabu': 'Rabu', 'Kamis': 'Kamis', 'Jumat': 'Jumat', 'Sabtu': 'Sabtu', 'Ahad': 'Ahad' },
            en: { 'Senin': 'Monday', 'Selasa': 'Tuesday', 'Rabu': 'Wednesday', 'Kamis': 'Thursday', 'Jumat': 'Friday', 'Sabtu': 'Saturday', 'Ahad': 'Sunday' }
        };

        const TEKS = {
            id: { btn: "MASUK PORTAL", report: "IZIN", notes: "Catatan Guru", schedule: "Jadwal", history: "Riwayat", greet: ["Selamat Pagi", "Selamat Siang", "Selamat Sore", "Selamat Malam"], spp_label: "Infaq SPP (Bulan Ini)", pay_status: "Status Pembayaran", status_unpaid: "Belum Ada Pembayaran" },
            en: { btn: "LOGIN", report: "ABSENCE", notes: "Teacher Notes", schedule: "Schedule", history: "History", greet: ["Good Morning", "Good Afternoon", "Good Evening", "Good Night"], spp_label: "Tuition Fee (Monthly)", pay_status: "Payment Status", status_unpaid: "Payment Pending" }
        };

        // --- CORE FUNCTIONS (DENGAN CACHE CEPAT) ---
        
        async function ambilData() {
            // 1. Cek apakah ada data tersimpan (Cache) untuk loading instan
            const cachedData = localStorage.getItem('rbm_data_cache');
            if (cachedData) {
                const parsed = JSON.parse(cachedData);
                DATA_SISWA = parsed.students; DATA_HARGA = parsed.prices; KABAR_RBM = parsed.news; INFO_PENGUMUMAN = parsed.info;
                finishLoad(); // Tampilkan langsung jika ada cache
            }

            // 2. Ambil data segar dari server (Update background)
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                // Simpan ke cache untuk kunjungan berikutnya
                localStorage.setItem('rbm_data_cache', JSON.stringify(data));
                
                // Update variabel
                DATA_SISWA = data.students; DATA_HARGA = data.prices; KABAR_RBM = data.news; INFO_PENGUMUMAN = data.info;
                
                // Jika belum ditampilkan (karena cache kosong), tampilkan sekarang
                if (!cachedData) finishLoad();
                else renderApp(); // Re-render jika ada update baru
            } catch (e) {
                if (!cachedData) {
                    alert("Gagal memuat data. Periksa internet.");
                    finishLoad();
                }
            }
        }

        function finishLoad() {
            const loader = document.getElementById('loader');
            if(loader.style.display === 'none') return;
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
                document.getElementById('app').classList.remove('hidden');
                renderApp();
            }, 500);
        }

        // --- UTILS ---
        function toggleModal(show) {
            const m = document.getElementById('modal-transfer');
            if(show) m.classList.add('active'); else m.classList.remove('active');
        }

        function copyText(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                document.getElementById('toast-msg').innerText = `${label} Disalin!`;
                document.getElementById('toast').classList.add('show');
                setTimeout(() => document.getElementById('toast').classList.remove('show'), 3000);
            });
        }

        function formatStatus(rawStatus) {
            // Logika menghaluskan bahasa: "Belum Bayar" -> "Belum Ada Pembayaran"
            const t = TEKS[STATE.lang];
            if (!rawStatus || rawStatus.toLowerCase().includes('belum')) return t.status_unpaid;
            return rawStatus;
        }

        function salinRincian(nama, total, rawStatus) {
            const statusHalus = formatStatus(rawStatus);
            const txt = `RBM JAPAN INVOICE\n------------------\nNama: ${nama}\nNominal: JPY ¬•${parseInt(total).toLocaleString('ja-JP')}\nStatus: ${statusHalus}\n\nMohon konfirmasi setelah transfer.`;
            copyText(txt, "Rincian SPP");
        }

        function getGreet() {
            const h = new Date().getHours();
            const g = TEKS[STATE.lang].greet;
            if (h < 11) return g[0]; if (h < 15) return g[1]; if (h < 19) return g[2]; return g[3];
        }

        // --- RENDER APP ---
        function renderApp() {
            const app = document.getElementById('app');
            const t = TEKS[STATE.lang];

            if (STATE.view === 'login') {
                // Sorting nama siswa abjad agar mudah dicari
                const sortedSiswa = [...DATA_SISWA].sort((a,b) => a.name.localeCompare(b.name));
                let opsi = `<option value="" disabled selected>Cari Nama Siswa...</option>` + sortedSiswa.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                
                app.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center p-8 fade-in relative overflow-hidden">
                    
                    <button onclick="STATE.lang=STATE.lang==='id'?'en':'id';renderApp()" class="absolute top-6 right-6 text-[10px] font-black bg-white/80 border border-emerald-100 px-3 py-1.5 rounded-full uppercase shadow-sm z-30 hover:bg-emerald-50 transition tracking-wide text-emerald-800">
                        üåê ${STATE.lang}
                    </button>

                    <div class="w-full max-w-sm relative z-10">
                        <div class="text-center mb-10">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-[1.5rem] shadow-xl shadow-emerald-100/50 mb-6 relative">
                                <img src="logo.png" class="h-10 object-contain" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2991/2991148.png'">
                            </div>
                            <h1 class="font-display font-black text-3xl text-emerald-900 tracking-tight mb-2">RBM PORTAL</h1>
                            <p class="text-emerald-600 text-xs font-bold uppercase tracking-widest bg-emerald-50 inline-block px-3 py-1 rounded-full border border-emerald-100">
                                ‚ú® Istiqomah di atas Sunnah
                            </p>
                        </div>

                        <div class="glass-card p-8 rounded-[2rem]">
                            <div class="relative mb-4 group">
                                <select id="selSiswa" class="w-full p-4 pl-5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500 appearance-none transition group-hover:bg-white">${opsi}</select>
                                <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><i data-lucide="chevron-down" width="16"></i></div>
                            </div>
                            <button onclick="const id=document.getElementById('selSiswa').value; if(id){STATE.user=DATA_SISWA.find(s=>s.id===id);STATE.view='dashboard';renderApp()}" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-2xl font-display font-bold text-sm tracking-wide shadow-lg shadow-emerald-200 transition transform active:scale-[0.98]">
                                ${t.btn} <i data-lucide="arrow-right" class="inline ml-1 w-4"></i>
                            </button>
                            
                            <div class="mt-6 text-center">
                                <a href="${WEBSITE_URL}" target="_blank" class="text-[10px] font-bold text-emerald-600/70 hover:text-emerald-700 transition flex items-center justify-center gap-1">
                                    <i data-lucide="globe" width="10"></i> Website Ruang Belajar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            } else {
                const s = STATE.user;
                // Hitung Tagihan
                let total = 0; s.classes.forEach(c => { total += (DATA_HARGA[c.split('(')[0].trim()] || 0); });
                if (s.role == 2) total *= 0.5;

                // Format Status Halus
                const rawStatus = s.payments["Bulan Ini"];
                const displayStatus = formatStatus(rawStatus);
                const isPaid = !displayStatus.toLowerCase().includes('belum');

                app.innerHTML = `
                <div class="pb-24 fade-in">
                    <div class="pt-10 px-8 pb-6 flex justify-between items-center">
                        <div>
                            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-0.5">${getGreet()},</p>
                            <h2 class="font-display font-black text-2xl text-emerald-950 leading-none">${s.name.split(' ')[0]}</h2>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="STATE.lang=STATE.lang==='id'?'en':'id';renderApp()" class="bg-white p-2.5 rounded-2xl border border-slate-100 text-emerald-700 text-[10px] font-black uppercase hover:bg-emerald-50 transition shadow-sm">${STATE.lang}</button>
                            <button onclick="location.reload()" class="bg-white p-2.5 rounded-2xl border border-slate-100 text-slate-400 hover:text-red-500 transition shadow-sm"><i data-lucide="log-out" width="18"></i></button>
                        </div>
                    </div>

                    <div class="px-6 space-y-6">
                        
                        <div class="virtual-card rounded-[2.5rem] p-7 relative group transform transition hover:scale-[1.01]">
                            <div class="flex justify-between items-start mb-8 relative z-10">
                                <div>
                                    <p class="text-[9px] font-medium text-emerald-100 uppercase tracking-widest mb-1 opacity-90">${t.spp_label}</p>
                                    <h1 class="font-display font-black text-4xl tracking-tight text-white">¬•${total.toLocaleString('ja-JP')}</h1>
                                </div>
                                <div class="w-10 h-7 rounded-lg bg-emerald-900/20 border border-emerald-300/30 flex items-center justify-center backdrop-blur-sm">
                                    <div class="w-6 h-4 border border-white/40 rounded-sm"></div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-end relative z-10">
                                <div>
                                    <p class="text-[9px] text-emerald-200 uppercase mb-1.5 font-semibold">${t.pay_status}</p>
                                    <span class="inline-flex items-center gap-1.5 bg-white/10 backdrop-blur-md px-3 py-1.5 rounded-xl text-[10px] font-bold border border-white/20 text-white">
                                        <div class="w-1.5 h-1.5 rounded-full ${isPaid ?'bg-emerald-300':'bg-orange-300 animate-pulse'}"></div> 
                                        ${displayStatus}
                                    </span>
                                </div>
                                <button onclick="laporIzin('${s.name}', '${s.id}')" class="bg-white text-emerald-800 px-4 py-2.5 rounded-xl text-[10px] font-bold shadow-lg hover:bg-emerald-50 transition flex items-center gap-1.5">
                                    <i data-lucide="send" width="12"></i> ${t.report}
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="window.open('https://wa.me/${ADMIN_WA}?text=Konfirmasi SPP ${s.name} Total: ¬•${total}')" class="glass-card p-4 rounded-3xl flex flex-col items-center gap-2 hover:bg-emerald-50/50 transition group">
                                <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center group-hover:scale-110 transition border border-emerald-100"><i data-lucide="message-circle" width="18"></i></div>
                                <span class="text-[10px] font-bold text-slate-600 text-center leading-tight">Konfirmasi<br>WhatsApp</span>
                            </button>
                            
                            <button onclick="toggleModal(true)" class="glass-card p-4 rounded-3xl flex flex-col items-center gap-2 hover:bg-blue-50/50 transition group">
                                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center group-hover:scale-110 transition border border-blue-100"><i data-lucide="credit-card" width="18"></i></div>
                                <span class="text-[10px] font-bold text-slate-600 text-center leading-tight">Info<br>Rekening</span>
                            </button>

                            <button onclick="salinRincian('${s.name}', '${total}', '${rawStatus}')" class="glass-card p-4 rounded-3xl flex flex-col items-center gap-2 hover:bg-slate-50/50 transition group">
                                <div class="w-10 h-10 bg-slate-50 text-slate-600 rounded-full flex items-center justify-center group-hover:scale-110 transition border border-slate-200"><i data-lucide="copy" width="18"></i></div>
                                <span class="text-[10px] font-bold text-slate-600 text-center leading-tight">Salin<br>Rincian</span>
                            </button>
                        </div>

                        ${INFO_PENGUMUMAN.aktif ? `
                        <div class="bg-orange-50/80 border border-orange-100 rounded-2xl p-1 overflow-hidden backdrop-blur-sm">
                            <div class="bg-orange-100/50 rounded-xl px-3 py-2.5">
                                <div class="ticker-text text-[11px] font-bold text-orange-800 italic">üì¢ ${STATE.lang==='id'?INFO_PENGUMUMAN.teks_id:INFO_PENGUMUMAN.teks_en}</div>
                            </div>
                        </div>` : ''}

                        <div class="space-y-6 pb-4">
                            <section>
                                <h3 class="font-display font-bold text-slate-800 text-sm mb-3 px-1 flex items-center gap-2">
                                    <i data-lucide="newspaper" class="text-emerald-600" width="14"></i> Kabar RBM
                                </h3>
                                <div class="flex gap-4 overflow-x-auto pb-4 px-1 snap-x hide-scroll">
                                    ${KABAR_RBM.map(k => `
                                    <div class="min-w-[240px] bg-white rounded-3xl border border-slate-100 overflow-hidden shadow-sm snap-center">
                                        <div class="h-28 bg-slate-200 relative"><img src="${k.foto}" class="w-full h-full object-cover"></div>
                                        <div class="p-4">
                                            <span class="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded uppercase">${k.tgl}</span>
                                            <h4 class="text-xs font-bold text-slate-800 mt-2 line-clamp-2">${k.judul}</h4>
                                        </div>
                                    </div>`).join('') || '<div class="w-full p-6 text-center text-xs text-slate-400 italic bg-white rounded-2xl border border-dashed">Belum ada kabar</div>'}
                                </div>
                            </section>

                            <div class="grid gap-4">
                                <section>
                                    <h3 class="font-display font-bold text-slate-800 text-sm mb-3 px-1">${t.schedule}</h3>
                                    <div class="space-y-2">
                                        ${s.schedule.map(sc => `
                                        <div class="bg-white p-3 rounded-2xl border border-slate-100 flex items-center gap-3 shadow-sm">
                                            <div class="bg-slate-50 w-12 h-12 rounded-xl flex flex-col items-center justify-center text-[9px] font-black text-slate-500 uppercase leading-none border border-slate-200">
                                                ${(DAY_NAMES[STATE.lang][sc.day] || sc.day).substring(0,3)}
                                            </div>
                                            <div>
                                                <p class="text-xs font-bold text-slate-800">${sc.subject}</p>
                                                <p class="text-[10px] text-emerald-600 font-bold flex items-center gap-1"><i data-lucide="clock" width="10"></i> ${sc.time} JST</p>
                                            </div>
                                        </div>`).join('') || '<p class="text-xs text-slate-400 italic text-center py-4 bg-white rounded-2xl border border-dashed">Tidak ada jadwal</p>'}
                                    </div>
                                </section>

                                <section>
                                    <h3 class="font-display font-bold text-slate-800 text-sm mb-3 px-1">${t.notes}</h3>
                                    <div class="space-y-2">
                                        ${s.notes.map(n => `
                                        <div class="bg-blue-50/40 p-4 rounded-2xl border border-blue-100">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-[9px] font-bold text-blue-500 uppercase">${n.date}</span>
                                                <i data-lucide="message-square" class="text-blue-300" width="12"></i>
                                            </div>
                                            <p class="text-xs text-slate-600 font-medium">"${n.message}"</p>
                                        </div>`).join('') || '<p class="text-xs text-slate-400 italic text-center py-4 bg-white rounded-2xl border border-dashed">Tidak ada catatan</p>'}
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            lucide.createIcons();
        }

        // Jalankan aplikasi
        ambilData();
    </script>
</body>
</html>
